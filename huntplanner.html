<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hunting Planner 25-26</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --panel-width: 380px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1B1B1B; color: #EAEAEA; overflow: hidden; }
        .main-container { position: relative; height: 100vh; width: 100%; }
        .map-section { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
        #map { height: 100%; width: 100%; }

        .map-ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1001;
            transition: opacity 0.3s ease;
        }
        .map-ui-container > * {
            pointer-events: auto;
        }
        #search-input {
            position: absolute; top: 20px; left: 20px; right: 20px;
            padding: 15px 20px; font-size: 1rem; border: 2px solid #4CAF50;
            border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            background: #2C2C2E; color: #EAEAEA; pointer-events: auto;
            max-width: 500px;
        }
        #search-input::placeholder {
            color: #999;
        }
        .custom-controls-container {
            display: flex;
            flex-direction: column;
            margin: 10px !important;
        }
        .custom-map-control-button {
            background-color: #2C2C2E; border: 2px solid #333; border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); color: #EAEAEA;
            cursor: pointer; font-family: inherit; font-size: 14px;
            font-weight: 600; line-height: 38px; margin-bottom: 10px !important;
            padding: 0 15px; text-align: center; pointer-events: auto;
            transition: all 0.2s ease;
        }
        .custom-map-control-button:hover {
            border-color: #4CAF50;
            background-color: #333;
        }
        .custom-map-control-button.active {
             border-color: #4CAF50;
             color: #4CAF50;
             font-weight: bold;
        }

        .mobile-button-container {
            display: none;
        }

        .mobile-toggle {
            background: #4CAF50; color: #1B1B1B;
            border: none; padding: 15px 25px; border-radius: 30px;
            font-size: 1.1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 1002;
            transition: all 0.3s ease;
        }
        .mobile-toggle:hover {
            background: #5CBF60;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }
        .mobile-toggle.initial {
            background: #FF5757;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .controls-panel {
            position: absolute; top: 0; right: 0; width: var(--panel-width); height: 100%;
            background: #1B1B1B; border-left: 1px solid #2C2C2E;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            z-index: 1010; transition: transform 0.3s ease-in-out;
        }
        .panel-header {
            background: #2C2C2E; padding: 25px; text-align: center;
            border-bottom: 1px solid #333; flex-shrink: 0; position: relative;
        }
        .panel-header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; }
        .panel-header p { font-size: 0.9rem; opacity: 0.8; }
        .panel-close {
            position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;
            background: #1B1B1B; border: 2px solid #555; border-radius: 50%;
            cursor: pointer; display: none; align-items: center; justify-content: center;
            font-size: 1.2rem; color: #999; transition: all 0.2s;
        }
        .panel-close:hover {
            border-color: #FF5757;
            color: #FF5757;
        }
        .panel-content { flex: 1; padding: 25px; overflow-y: auto; }
        .step-section { margin-bottom: 30px; background: #2C2C2E; border-radius: 8px; padding: 20px; border: 1px solid #333; }
        .step-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .step-number { background: #4CAF50; color: #1B1B1B; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; flex-shrink: 0; }
        .step-title { font-size: 1.2rem; font-weight: 600; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 16px; border: 2px solid #555;
            border-radius: 6px; font-size: 1rem; background: #1B1B1B; color: #EAEAEA;
            transition: border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #4CAF50;
            background: #1B1B1B;
        }
        .form-group input[readonly] { background: #2C2C2E; color: #999; cursor: not-allowed; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        .game-type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .game-type-btn {
            flex: 1; padding: 10px; border: 2px solid #555; border-radius: 6px;
            background: #1B1B1B; cursor: pointer; text-align: center; font-weight: 600;
            transition: all 0.2s;
        }
        .game-type-btn:hover { border-color: #777; }
        .game-type-btn.active { background: #4CAF50; color: #1B1B1B; border-color: #4CAF50; }
        .status-indicator { display: flex; align-items: center; gap: 8px; padding: 10px 15px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; margin-bottom: 15px; }
        .status-waiting { background: rgba(255, 191, 0, 0.1); color: #FFBF00; border: 1px solid rgba(255, 191, 0, 0.3); }
        .status-ready { background: rgba(76, 175, 80, 0.1); color: #4CAF50; border: 1px solid rgba(76, 175, 80, 0.3); }
        .status-error { background: rgba(255, 87, 87, 0.1); color: #FF5757; border: 1px solid rgba(255, 87, 87, 0.3); }
        .status-calculating { background: rgba(255, 191, 0, 0.1); color: #FFBF00; border: 1px solid rgba(255, 191, 0, 0.3); }
        .btn { background: #4CAF50; color: #1B1B1B; border: none; padding: 14px 24px; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn:hover { background: #5CBF60; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:disabled:hover { background: #4CAF50; }

        .loading-spinner {
            display: inline-block; width: 1.2em; height: 1.2em;
            border: 3px solid transparent; border-top-color: #1B1B1B;
            border-radius: 50%; animation: spin 1s linear infinite;
            vertical-align: middle; margin-left: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .route-options { display: none; margin-top: 15px; }
        .route-options.show { display: block; }
        .route-option { background: #1B1B1B; border: 2px solid #333; border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .route-option:hover { border-color: #4CAF50; }
        .route-option.selected { border-color: #FFBF00; background: rgba(255, 191, 0, 0.1); }
        .route-summary { display: flex; justify-content: space-between; align-items: center; }
        .route-time { font-weight: bold; color: #4CAF50; font-size: 1.1rem; }
        .route-distance { color: #999; font-size: 0.9rem; }
        .route-description { margin-top: 5px; font-size: 0.8rem; color: #999; }
        .drive-time-adjuster { display: none; margin-top: 15px; background: #1B1B1B; padding: 15px; border-radius: 6px; border: 1px solid #333; }
        .drive-time-adjuster.show { display: block; }
        .help-text { font-size: 0.85rem; color: #999; margin-bottom: 10px; }
        .time-adjuster-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .time-btn { background: #4CAF50; color: #1B1B1B; border: none; width: 35px; height: 35px; border-radius: 4px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .time-btn:hover { background: #5CBF60; }
        .time-display { flex: 1; text-align: center; font-size: 1.1rem; font-weight: bold; color: #FFBF00; }
        .results-section { display: none; margin-bottom: 30px;}
        .results-section.show { display: block; }
        .timeline, .info-grid { background: #1B1B1B; border-radius: 6px; padding: 20px; }
        .timeline-item { 
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            padding: 12px 0; 
            border-bottom: 1px solid #333; 
        }
        .timeline-item.highlight { background: rgba(76, 175, 80, 0.1); padding: 12px 10px; border-radius: 6px; margin: 5px 0; }
        .timeline-item:last-child { border-bottom: none; }
        .timeline-label { font-weight: 500; }
        .timeline-time { font-weight: bold; color: #4CAF50; text-align: right; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem; margin-top: 20px; }
        .info-item { padding: 15px; border-left: 3px solid #4CAF50; background: #2C2C2E; border-radius: 4px; }
        .info-label { font-weight: 600; margin-bottom: 5px; }
        .info-value { color: #CCC; }
        .info-calc { font-size: 0.8rem; color: #999; margin-top: 5px; }
        .info-calc a { color: #4CAF50; text-decoration: none; }
        .info-calc a:hover { text-decoration: underline; }
        .btn-copy { margin-top: 15px; }
        
        .state-badge {
            display: inline-block; padding: 4px 10px; border-radius: 4px;
            background: rgba(76, 175, 80, 0.2); color: #4CAF50;
            font-size: 0.85rem; font-weight: 600; margin-left: 10px;
        }

        .weather-forecast {
            background: #1B1B1B; border-radius: 6px; padding: 20px;
        }
        .weather-item {
            display: grid;
            grid-template-columns: 80px 40px 1fr;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        .weather-item:last-child { border-bottom: none; }
        .weather-time { font-weight: bold; font-size: 1rem; color: #EAEAEA; }
        .weather-arrow {
            width: 32px; height: 32px;
            fill: #FFBF00;
        }
        .weather-details {
            display: flex; flex-direction: column;
            gap: 4px; text-align: left;
        }
        .weather-speed { font-weight: bold; font-size: 1rem; color: #4CAF50; }
        .weather-temp { font-size: 0.9rem; color: #999; }
        .weather-conditions { font-size: 0.9rem; color: #ccc; text-transform: capitalize; }


        /* --- MOBILE STYLES --- */
        @media (max-width: 768px) {
            body { overflow: hidden; }
            .main-container {
                display: flex; flex-direction: column;
                height: 100vh; height: 100dvh;
            }
            .map-section {
                position: relative; flex: 1; min-height: 0;
            }
            #map .gm-style > div:nth-child(2) {
                padding-top: 70px !important;
            }
            .custom-controls-container {
                margin-top: 60px !important;
            }

            .mobile-button-container {
                display: flex; align-items: center; justify-content: center;
                height: 90px; flex-shrink: 0; background-color: #1B1B1B;
                padding: 15px; box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
                z-index: 1002; transition: transform 0.3s ease;
            }
            .mobile-toggle { width: 100%; max-width: 400px; }
            #search-input { right: 20px; }
            .controls-panel {
                position: fixed; top: auto; bottom: 0; left: 0; right: 0; width: 100%;
                height: 100%; max-height: 100%; border-left: none;
                border-top: 1px solid #333; border-radius: 20px 20px 0 0;
                transform: translateY(100%);
            }
            .controls-panel.show { transform: translateY(0); }
            .panel-close { display: flex; }
            .panel-header::before {
                content: ''; display: block; width: 50px; height: 5px;
                background: #555; border-radius: 3px; margin: -10px auto 15px;
            }
            body.panel-is-open .map-ui-container { opacity: 0; pointer-events: none; }
            body.panel-is-open .mobile-button-container { transform: translateY(100%); }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="map-section">
        <div id="map"></div>
    </div>

    <div class="map-ui-container">
        <input type="text" id="search-input" placeholder="Search for a location...">
    </div>

    <div class="controls-panel" id="controlsPanel">
        <div class="panel-header">
            <div class="panel-close" id="panelClose">×</div>
            <h1>Hunt Planner</h1>
            <p>Legal shooting times & timeline calculator</p>
        </div>
        <div class="panel-content">
            <div id="wizard-step-route" class="wizard-step" style="display: none;">
                <div class="step-section">
                     <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">Choose Route</div>
                    </div>
                    <div id="driveTimeStatus" class="status-indicator status-waiting">
                        Set start & hunt locations to calculate drive time.
                    </div>
                    <div id="routeOptions" class="route-options"></div>
                    <div class="form-group">
                         <button id="changeStartLocationBtn" class="btn">Edit Start Location</button>
                    </div>
                </div>
            </div>

            <div id="wizard-step-details" class="wizard-step" style="display: none;">
                <div class="step-section">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">Final Details</div>
                    </div>
                     <div class="form-group">
                        <label for="huntDate">Hunt Date</label>
                        <input type="date" id="huntDate">
                    </div>
                    <div class="form-group">
                         <label>Game Type</label>
                        <div class="game-type-selector">
                            <div class="game-type-btn active" data-type="deer">Deer</div>
                            <div class="game-type-btn" data-type="waterfowl">Waterfowl</div>
                        </div>
                    </div>
                    <div id="driveTimeAdjuster" class="drive-time-adjuster">
                        <label>Adjust Drive Time:</label>
                        <div class="help-text">Add extra time for stops, fuel, etc.</div>
                        <div class="time-adjuster-controls">
                            <button type="button" class="time-btn" data-adjust="-5">-5</button>
                            <button type="button" class="time-btn" data-adjust="-1">-1</button>
                            <div class="time-display"><span id="adjustedTime">0</span> min</div>
                            <button type="button" class="time-btn" data-adjust="1">+1</button>
                            <button type="button" class="time-btn" data-adjust="5">+5</button>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="parkToSetTime">Walk from Park to Spot (minutes)</label>
                        <input type="number" id="parkToSetTime" min="0" value="10">
                    </div>
                    <div class="form-group">
                        <label for="setToEstablishTime">Setup Time in Spot (minutes)</label>
                        <input type="number" id="setToEstablishTime" min="0" value="20">
                    </div>
                    <div class="form-group">
                        <label for="bufferTime">"Quiet Time" Buffer (minutes)</label>
                        <input type="number" id="bufferTime" min="0" value="15">
                    </div>
                </div>
            </div>

            <div id="wizard-step-results" class="wizard-step" style="display: none;">
                <div id="resultsSection" class="results-section">
                    <div class="step-header">
                        <div class="step-number">✓</div>
                        <div class="step-title">Your Timeline</div>
                    </div>
                    <div id="timeline-results"></div>
                    <div id="info-grid-results"></div>
                </div>
                 <div id="weather-forecast-results" class="results-section"></div>
                 <div class="copy-section">
                    <button id="copyButton" class="btn btn-copy">Copy Plan to Share</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-button-container">
        <button class="mobile-toggle initial" id="mobileToggle">Select Hunt Location</button>
    </div>
</div>


<script>
    // Kearney, NE coordinates for reference
    const KEARNEY_COORDS = { lat: 40.6993, lng: -99.0817 };
    const MILES_PER_MINUTE = 9;

    // Nebraska sunrise/sunset chart data
    const sunData={"2025-09-01":{sunrise:"7:04",sunset:"8:08"},"2025-09-02":{sunrise:"7:05",sunset:"8:06"},"2025-09-03":{sunrise:"7:06",sunset:"8:05"},"2025-09-04":{sunrise:"7:07",sunset:"8:03"},"2025-09-05":{sunrise:"7:08",sunset:"8:01"},"2025-09-06":{sunrise:"7:09",sunset:"8:00"},"2025-09-07":{sunrise:"7:10",sunset:"7:58"},"2025-09-08":{sunrise:"7:11",sunset:"7:56"},"2025-09-09":{sunrise:"7:12",sunset:"7:55"},"2025-09-10":{sunrise:"7:12",sunset:"7:53"},"2025-09-11":{sunrise:"7:13",sunset:"7:51"},"2025-09-12":{sunrise:"7:14",sunset:"7:50"},"2025-09-13":{sunrise:"7:15",sunset:"7:48"},"2025-09-14":{sunrise:"7:16",sunset:"7:46"},"2025-09-15":{sunrise:"7:17",sunset:"7:45"},"2025-09-16":{sunrise:"7:18",sunset:"7:43"},"2025-09-17":{sunrise:"7:19",sunset:"7:41"},"2025-09-18":{sunrise:"7:20",sunset:"7:40"},"2025-09-19":{sunrise:"7:21",sunset:"7:38"},"2025-09-20":{sunrise:"7:22",sunset:"7:36"},"2025-09-21":{sunrise:"7:23",sunset:"7:34"},"2025-09-22":{sunrise:"7:24",sunset:"7:33"},"2025-09-23":{sunrise:"7:25",sunset:"7:31"},"2025-09-24":{sunrise:"7:26",sunset:"7:29"},"2025-09-25":{sunrise:"7:27",sunset:"7:28"},"2025-09-26":{sunrise:"7:28",sunset:"7:26"},"2025-09-27":{sunrise:"7:29",sunset:"7:24"},"2025-09-28":{sunrise:"7:30",sunset:"7:23"},"2025-09-29":{sunrise:"7:31",sunset:"7:21"},"2025-09-30":{sunrise:"7:32",sunset:"7:19"},"2025-10-01":{sunrise:"7:33",sunset:"7:18"},"2025-10-02":{sunrise:"7:34",sunset:"7:16"},"2025-10-03":{sunrise:"7:35",sunset:"7:14"},"2025-10-04":{sunrise:"7:36",sunset:"7:13"},"2025-10-05":{sunrise:"7:37",sunset:"7:11"},"2025-10-06":{sunrise:"7:38",sunset:"7:10"},"2025-10-07":{sunrise:"7:39",sunset:"7:08"},"2025-10-08":{sunrise:"7:40",sunset:"7:06"},"2025-10-09":{sunrise:"7:42",sunset:"7:05"},"2025-10-10":{sunrise:"7:43",sunset:"7:03"},"2025-10-11":{sunrise:"7:44",sunset:"7:02"},"2025-10-12":{sunrise:"7:45",sunset:"7:00"},"2025-10-13":{sunrise:"7:46",sunset:"6:59"},"2025-10-14":{sunrise:"7:47",sunset:"6:57"},"2025-10-15":{sunrise:"7:48",sunset:"6:55"},"2025-10-16":{sunrise:"7:49",sunset:"6:54"},"2025-10-17":{sunrise:"7:50",sunset:"6:52"},"2025-10-18":{sunrise:"7:51",sunset:"6:51"},"2025-10-19":{sunrise:"7:52",sunset:"6:50"},"2025-10-20":{sunrise:"7:53",sunset:"6:48"},"2025-10-21":{sunrise:"7:55",sunset:"6:47"},"2025-10-22":{sunrise:"7:56",sunset:"6:45"},"2025-10-23":{sunrise:"7:57",sunset:"6:44"},"2025-10-24":{sunrise:"7:58",sunset:"6:42"},"2025-10-25":{sunrise:"7:59",sunset:"6:41"},"2025-10-26":{sunrise:"8:00",sunset:"6:40"},"2025-10-27":{sunrise:"8:01",sunset:"6:38"},"2025-10-28":{sunrise:"8:02",sunset:"6:37"},"2025-10-29":{sunrise:"8:04",sunset:"6:36"},"2025-10-30":{sunrise:"8:05",sunset:"6:35"},"2025-10-31":{sunrise:"8:06",sunset:"6:33"},"2025-11-01":{sunrise:"8:07",sunset:"6:32"},"2025-11-02":{sunrise:"7:08",sunset:"5:31"},"2025-11-03":{sunrise:"7:09",sunset:"5:30"},"2025-11-04":{sunrise:"7:11",sunset:"5:29"},"2025-11-05":{sunrise:"7:12",sunset:"5:28"},"2025-11-06":{sunrise:"7:13",sunset:"5:27"},"2025-11-07":{sunrise:"7:14",sunset:"5:25"},"2025-11-08":{sunrise:"7:15",sunset:"5:24"},"2025-11-09":{sunrise:"7:16",sunset:"5:23"},"2025-11-10":{sunrise:"7:18",sunset:"5:22"},"2025-11-11":{sunrise:"7:19",sunset:"5:21"},"2025-11-12":{sunrise:"7:20",sunset:"5:21"},"2025-11-13":{sunrise:"7:21",sunset:"5:20"},"2025-11-14":{sunrise:"7:22",sunset:"5:19"},"2025-11-15":{sunrise:"7:24",sunset:"5:18"},"2025-11-16":{sunrise:"7:25",sunset:"5:17"},"2025-11-17":{sunrise:"7:26",sunset:"5:16"},"2025-11-18":{sunrise:"7:27",sunset:"5:16"},"2025-11-19":{sunrise:"7:28",sunset:"5:15"},"2025-11-20":{sunrise:"7:29",sunset:"5:14"},"2025-11-21":{sunrise:"7:30",sunset:"5:14"},"2025-11-22":{sunrise:"7:32",sunset:"5:13"},"2025-11-23":{sunrise:"7:33",sunset:"5:13"},"2025-11-24":{sunrise:"7:34",sunset:"5:12"},"2025-11-25":{sunrise:"7:35",sunset:"5:12"},"2025-11-26":{sunrise:"7:36",sunset:"5:11"},"2025-11-27":{sunrise:"7:37",sunset:"5:11"},"2025-11-28":{sunrise:"7:38",sunset:"5:10"},"2025-11-29":{sunrise:"7:39",sunset:"5:10"},"2025-11-30":{sunrise:"7:40",sunset:"5:10"},"2025-12-01":{sunrise:"7:41",sunset:"5:10"},"2025-12-02":{sunrise:"7:42",sunset:"5:09"},"2025-12-03":{sunrise:"7:43",sunset:"5:09"},"2025-12-04":{sunrise:"7:44",sunset:"5:09"},"2025-12-05":{sunrise:"7:45",sunset:"5:09"},"2025-12-06":{sunrise:"7:46",sunset:"5:09"},"2025-12-07":{sunrise:"7:47",sunset:"5:09"},"2025-12-08":{sunrise:"7:48",sunset:"5:09"},"2025-12-09":{sunrise:"7:49",sunset:"5:09"},"2025-12-10":{sunrise:"7:50",sunset:"5:09"},"2025-12-11":{sunrise:"7:50",sunset:"5:09"},"2025-12-12":{sunrise:"7:51",sunset:"5:09"},"2025-12-13":{sunrise:"7:52",sunset:"5:09"},"2025-12-14":{sunrise:"7:53",sunset:"5:10"},"2025-12-15":{sunrise:"7:53",sunset:"5:10"},"2025-12-16":{sunrise:"7:54",sunset:"5:10"},"2025-12-17":{sunrise:"7:55",sunset:"5:11"},"2025-12-18":{sunrise:"7:55",sunset:"5:11"},"2025-12-19":{sunrise:"7:56",sunset:"5:11"},"2025-12-20":{sunrise:"7:56",sunset:"5:12"},"2025-12-21":{sunrise:"7:57",sunset:"5:12"},"2025-12-22":{sunrise:"7:57",sunset:"5:13"},"2025-12-23":{sunrise:"7:58",sunset:"5:13"},"2025-12-24":{sunrise:"7:58",sunset:"5:14"},"2025-12-25":{sunrise:"7:59",sunset:"5:15"},"2025-12-26":{sunrise:"7:59",sunset:"5:15"},"2025-12-27":{sunrise:"7:59",sunset:"5:16"},"2025-12-28":{sunrise:"8:00",sunset:"5:17"},"2025-12-29":{sunrise:"8:00",sunset:"5:17"},"2025-12-30":{sunrise:"8:00",sunset:"5:18"},"2025-12-31":{sunrise:"8:00",sunset:"5:19"},"2026-01-01":{sunrise:"8:00",sunset:"5:20"},"2026-01-02":{sunrise:"8:00",sunset:"5:21"},"2026-01-03":{sunrise:"8:00",sunset:"5:22"},"2026-01-04":{sunrise:"8:00",sunset:"5:23"},"2026-01-05":{sunrise:"8:00",sunset:"5:23"},"2026-01-06":{sunrise:"8:00",sunset:"5:24"},"2026-01-07":{sunrise:"8:00",sunset:"5:25"},"2026-01-08":{sunrise:"8:00",sunset:"5:26"},"2026-01-09":{sunrise:"8:00",sunset:"5:27"},"2026-01-10":{sunrise:"8:00",sunset:"5:28"},"2026-01-11":{sunrise:"7:59",sunset:"5:29"},"2026-01-12":{sunrise:"7:59",sunset:"5:31"},"2026-01-13":{sunrise:"7:59",sunset:"5:32"},"2026-01-14":{sunrise:"7:58",sunset:"5:33"},"2026-01-15":{sunrise:"7:58",sunset:"5:34"},"2026-01-16":{sunrise:"7:58",sunset:"5:35"},"2026-01-17":{sunrise:"7:57",sunset:"5:36"},"2026-01-18":{sunrise:"7:57",sunset:"5:37"},"2026-01-19":{sunrise:"7:56",sunset:"5:38"},"2026-01-20":{sunrise:"7:56",sunset:"5:40"},"2026-01-21":{sunrise:"7:55",sunset:"5:41"},"2026-01-22":{sunrise:"7:54",sunset:"5:42"},"2026-01-23":{sunrise:"7:54",sunset:"5:43"},"2026-01-24":{sunrise:"7:53",sunset:"5:44"},"2026-01-25":{sunrise:"7:52",sunset:"5:46"},"2026-01-26":{sunrise:"7:51",sunset:"5:47"},"2026-01-27":{sunrise:"7:51",sunset:"5:48"},"2026-01-28":{sunrise:"7:50",sunset:"5:49"},"2026-01-29":{sunrise:"7:49",sunset:"5:51"},"2026-01-30":{sunrise:"7:48",sunset:"5:52"},"2026-01-31":{sunrise:"7:47",sunset:"5:53"},"2026-02-01":{sunrise:"7:46",sunset:"5:54"},"2026-02-02":{sunrise:"7:45",sunset:"5:55"},"2026-02-03":{sunrise:"7:44",sunset:"5:57"},"2026-02-04":{sunrise:"7:43",sunset:"5:58"},"2026-02-05":{sunrise:"7:42",sunset:"5:59"},"2026-02-06":{sunrise:"7:41",sunset:"6:00"},"2026-02-07":{sunrise:"7:40",sunset:"6:02"},"2026-02-08":{sunrise:"7:39",sunset:"6:03"},"2026-02-09":{sunrise:"7:37",sunset:"6:04"},"2026-02-10":{sunrise:"7:36",sunset:"6:05"},"2026-02-11":{sunrise:"7:35",sunset:"6:06"},"2026-02-12":{sunrise:"7:34",sunset:"6:08"},"2026-02-13":{sunrise:"7:33",sunset:"6:09"},"2026-02-14":{sunrise:"7:31",sunset:"6:10"},"2026-02-15":{sunrise:"7:30",sunset:"6:11"},"2026-02-16":{sunrise:"7:29",sunset:"6:13"},"2026-02-17":{sunrise:"7:27",sunset:"6:14"},"2026-02-18":{sunrise:"7:26",sunset:"6:15"},"2026-02-19":{sunrise:"7:25",sunset:"6:16"},"2026-02-20":{sunrise:"7:23",sunset:"6:17"},"2026-02-21":{sunrise:"7:22",sunset:"6:18"},"2026-02-22":{sunrise:"7:20",sunset:"6:20"},"2026-02-23":{sunrise:"7:19",sunset:"6:21"},"2026-02-24":{sunrise:"7:17",sunset:"6:22"},"2026-02-25":{sunrise:"7:16",sunset:"6:23"},"2026-02-26":{sunrise:"7:15",sunset:"6:24"},"2026-02-27":{sunrise:"7:13",sunset:"6:25"},"2026-02-28":{sunrise:"7:12",sunset:"6:27"}};

    // --- App State & Variables ---
    let map, currentMarker, startLocationMarker, infoWindow, directionsService, directionsRenderer;
    let startLocation = null;
    let huntLocation = null;
    let isLocationSet = false;
    let baseDriveTime = 0;
    let driveTimeAdjustment = 0;
    let selectedGameType = 'deer';
    let alternateRoutePolylines = [];
    let fullDirectionsResponse = null;
    let locationAccessDenied = false;
    let currentState = null;
    let isSettingStartLocation = false;
    let currentWizardStep = 'initial'; // To manage the wizard state

    // TZ UPGRADE: Add state variables for time zone information
    let startZoneInfo = { id: null, abbreviation: null };
    let huntZoneInfo = { id: null, abbreviation: null };
    
    const TIMEZONE_API_KEY = 'AIzaSyCT9XxjxT5t4Wyjwg0_s2drfClF_TijOLQ';
    const WEATHER_API_KEY = 'c3e6734aa6375dfb0204060fffb7ba22';


    function initMap() {
        // Expanded bounds to include NE, IA, WY, KS
        const defaultLocation = { lat: 41.5, lng: -99.5 };
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 6, 
            center: defaultLocation, 
            mapTypeId: 'hybrid', 
            gestureHandling: 'greedy',
            restriction: { 
                latLngBounds: { 
                    north: 45.0, south: 37.0, west: -106.0, east: -90.0
                }, 
                strictBounds: false 
            },
            mapTypeControl: false, 
            streetViewControl: false, 
            zoomControl: true, 
            scaleControl: true, 
            rotateControl: false, 
            fullscreenControl: true
        });
        
        const controlsContainer = document.createElement("div");
        controlsContainer.classList.add("custom-controls-container");

        const locationButton = document.createElement("button");
        locationButton.textContent = "My Location";
        locationButton.classList.add("custom-map-control-button");
        controlsContainer.appendChild(locationButton);
        
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlsContainer);

        locationButton.addEventListener("click", () => {
            if (startLocationMarker) {
                map.setCenter(startLocationMarker.getPosition());
                map.setZoom(12);
            } else if (locationAccessDenied) {
                alert("Location access was denied. Please enable location in your browser settings.");
            } else {
                tryGeolocation();
            }
        });
        
        directionsRenderer = new google.maps.DirectionsRenderer({
            suppressMarkers: true,
            polylineOptions: { strokeColor: '#4CAF50', strokeWeight: 8, strokeOpacity: 0.9 }
        });
        directionsRenderer.setMap(map);

        infoWindow = new google.maps.InfoWindow();
        directionsService = new google.maps.DirectionsService();

        const searchInput = document.getElementById("search-input");
        const searchBox = new google.maps.places.SearchBox(searchInput);

        map.addListener("bounds_changed", () => searchBox.setBounds(map.getBounds()));

        searchBox.addListener("places_changed", () => {
            const places = searchBox.getPlaces();
            if (places.length > 0) {
                isSettingStartLocation = false;
                placeMarker(places[0].geometry.location);
            }
        });

        map.addListener("click", (e) => placeMarker(e.latLng));

        addEventListeners();
        setTodaysDate();
        tryGeolocation();
        setStartZone();
    }

    function addEventListeners() {
        document.getElementById('huntDate').addEventListener('change', updateCalculateButton);
        document.getElementById('mobileToggle').addEventListener('click', handleWizardNavigation);
        document.getElementById('changeStartLocationBtn').addEventListener('click', toggleSetStartLocation);
        
        document.getElementById('panelClose').addEventListener('click', () => setPanelVisibility(false));

        document.querySelectorAll('.game-type-btn[data-type]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.game-type-btn[data-type]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedGameType = this.dataset.type;
            });
        });
        
        document.querySelectorAll('.time-btn').forEach(button => {
            button.addEventListener('click', function() {
                const amount = parseInt(this.dataset.adjust, 10);
                adjustDriveTime(amount);
            });
        });
    }
    
    function setPanelVisibility(show) {
        const controlsPanel = document.getElementById('controlsPanel');
        controlsPanel.classList.toggle('show', show);
        document.body.classList.toggle('panel-is-open', show);
    }

    function tryGeolocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userCoords = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    setStartLocation(userCoords, true); // true = pan map to location
                    updateDriveTimeStatus('Your location found. Now select a hunting spot on the map.', 'ready');
                    locationAccessDenied = false;
                },
                (error) => {
                    locationAccessDenied = true;
                    let message = 'Could not get your location.';
                    if (error.code === error.PERMISSION_DENIED) message = 'Location access denied. Drive time calculation disabled.';
                    else if (error.code === error.POSITION_UNAVAILABLE) message = 'Location information unavailable.';
                    else if (error.code === error.TIMEOUT) message = 'Location request timed out.';
                    updateDriveTimeStatus(message, 'error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            updateDriveTimeStatus('Geolocation is not supported by your browser.', 'error');
        }
    }

    function setStartLocation(location, panTo = false) {
        startLocation = { lat: location.lat(), lng: location.lng() };

        if (startLocationMarker) {
            startLocationMarker.setPosition(location);
        } else {
            startLocationMarker = new google.maps.Marker({
                position: location, map: map, title: "Your Start Location",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: "#4CAF50",
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: "#ffffff"
                },
            });
        }

        if (panTo) {
            map.setCenter(location);
            map.setZoom(10);
        }

        if (huntLocation) {
            calculateAndDisplayRoute(new google.maps.LatLng(huntLocation.lat, huntLocation.lng));
        }
        updateCalculateButton();
    }

    async function placeMarker(location) {
        if (isSettingStartLocation) {
            setStartLocation(location);
            isSettingStartLocation = false;
            const btn = document.getElementById('changeStartLocationBtn');
            btn.classList.remove('active');
            btn.textContent = 'Edit Start Location';
            updateLocationStatus('Start location updated. Please re-select a route.', 'ready');
            return; 
        }

        const lat = location.lat();
        const lng = location.lng();
        
        huntLocation = { lat: lat, lng: lng };
        currentState = detectState(lat, lng);
        updateStateBadge(currentState);
        await getHuntZone(lat, lng);

        isLocationSet = true;
        
        if (currentMarker) {
            currentMarker.setPosition(location);
        } else {
            currentMarker = new google.maps.Marker({
                position: location, map: map, draggable: true, title: 'Hunting Location',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE, scale: 12,
                    fillColor: "#FFBF00", fillOpacity: 0.9,
                    strokeWeight: 3, strokeColor: "#fff"
                }
            });
            currentMarker.addListener('dragend', (e) => placeMarker(e.latLng));
        }

        if (startLocation) {
            calculateAndDisplayRoute(location);
        }
    }

    function calculateAndDisplayRoute(destination) {
        if (!startLocation) {
            updateDriveTimeStatus("Set start location to calculate route.", "waiting");
            return;
        }
        updateDriveTimeStatus("Calculating route...", "calculating");
        clearRoutes();
        directionsService.route({
            origin: startLocation,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING,
            provideRouteAlternatives: true
        }, (response, status) => {
            if (status === "OK") {
                fullDirectionsResponse = response;
                updateWizardState('route-selection');
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(new google.maps.LatLng(startLocation.lat, startLocation.lng));
                bounds.extend(destination);
                map.fitBounds(bounds, 50); // Add padding
                showRouteOptions(response.routes);
                updateDriveTimeStatus(`${response.routes.length} route(s) found. Choose one below or on the map.`, "ready");
            } else {
                updateDriveTimeStatus('Could not calculate drive time. Check connection.', 'error');
            }
        });
    }

    function showRouteOptions(routes) {
        clearRoutes(); 
        directionsRenderer.setDirections(fullDirectionsResponse);

        const routesList = document.getElementById('routeOptions');
        routesList.innerHTML = '';
        
        for (let i = 1; i < routes.length; i++) {
            const polyline = new google.maps.Polyline({
                path: routes[i].overview_path, strokeColor: '#888888',
                strokeOpacity: 0.7, strokeWeight: 6, map: map, zIndex: 1
            });
            polyline.addListener('click', () => selectRoute(i));
            alternateRoutePolylines.push(polyline);
        }

        routes.forEach((route, index) => {
            const routeDiv = document.createElement('div');
            routeDiv.className = 'route-option';
            routeDiv.dataset.routeIndex = index;
            const duration = Math.round(route.legs[0].duration.value / 60);
            const distance = route.legs[0].distance.text;
            const summary = route.summary || 'Main route';
            routeDiv.innerHTML = `
                <div class="route-summary">
                    <div class="route-time">${duration} min</div>
                    <div class="route-distance">${distance}</div>
                </div>
                <div class="route-description">via ${summary}</div>`;
            routeDiv.addEventListener('click', () => selectRoute(index));
            routesList.appendChild(routeDiv);
        });

        selectRoute(0); // Select the first route by default
        document.getElementById('routeOptions').classList.add('show');
    }

    function selectRoute(index) {
        directionsRenderer.setRouteIndex(index);
        document.querySelectorAll('.route-option').forEach(r => r.classList.remove('selected'));
        const selectedOption = document.querySelector(`.route-option[data-route-index='${index}']`);
        if(selectedOption) selectedOption.classList.add('selected');
        updateDriveTime(fullDirectionsResponse.routes[index]);
        updateWizardState('ready-to-plan');
    }

    function updateDriveTime(route) {
        baseDriveTime = Math.round(route.legs[0].duration.value / 60);
        driveTimeAdjustment = 0;
        const totalTime = baseDriveTime + driveTimeAdjustment;
        document.getElementById('adjustedTime').textContent = totalTime;
    }
    
    function adjustDriveTime(minutes) {
        driveTimeAdjustment += minutes;
        const totalTime = Math.max(0, baseDriveTime + driveTimeAdjustment);
        document.getElementById('adjustedTime').textContent = totalTime;
    }

    function clearRoutes() {
        if (directionsRenderer) directionsRenderer.setDirections({routes: []});
        alternateRoutePolylines.forEach(p => p.setMap(null));
        alternateRoutePolylines = [];
    }

    async function getSunriseSunsetForLocation(lat, lng, date) {
        const url = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&date=${date}&formatted=0`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.status === 'OK') {
                return {
                    sunrise: data.results.sunrise,
                    sunset: data.results.sunset
                };
            }
        } catch (error) { console.error('Error fetching sunrise/sunset:', error); }
        return null;
    }

    function handleWizardNavigation() {
        if (currentWizardStep === 'ready-to-plan') {
            updateWizardState('details');
        } else if (currentWizardStep === 'details') {
            calculateTimeline();
        } else {
             setPanelVisibility(true);
        }
    }

    function toggleSetStartLocation() {
        isSettingStartLocation = true;
        const btn = document.getElementById('changeStartLocationBtn');
        btn.classList.add('active');
        btn.textContent = 'Now Click Map to Set New Start...';
        updateLocationStatus('Waiting for new start location...', 'calculating');
        setPanelVisibility(false); // Hide panel to allow map clicking
    }

    function updateWizardState(newStep) {
        currentWizardStep = newStep;
        const mobileButton = document.getElementById('mobileToggle');
        
        document.querySelectorAll('.wizard-step').forEach(el => el.style.display = 'none');

        if (newStep === 'initial') {
            setPanelVisibility(false);
            mobileButton.textContent = 'Select Hunt Location';
            mobileButton.classList.add('initial');
            mobileButton.classList.remove('active');
        } else if (newStep === 'route-selection') {
            document.getElementById('wizard-step-route').style.display = 'block';
            setPanelVisibility(true);
            mobileButton.textContent = 'Choose Route or Edit Start';
            mobileButton.classList.add('initial');
            mobileButton.classList.remove('active');
        } else if (newStep === 'ready-to-plan') {
            mobileButton.textContent = 'Next: Set Details';
            mobileButton.classList.remove('initial');
            mobileButton.classList.add('active');
        } else if (newStep === 'details') {
            document.getElementById('wizard-step-route').style.display = 'none';
            document.getElementById('wizard-step-details').style.display = 'block';
            document.getElementById('driveTimeAdjuster').classList.add('show');
            mobileButton.textContent = 'Plan My Hunt';
        } else if (newStep === 'results') {
            document.getElementById('wizard-step-results').style.display = 'block';
            mobileButton.textContent = 'Plan a New Hunt';
            mobileButton.onclick = () => window.location.reload();
        }
    }

    async function calculateTimeline() {
        const button = document.getElementById('mobileToggle');
        button.innerHTML = `<span class="loading-spinner" style="border-top-color: #fff;"></span> Calculating...`;
        button.disabled = true;

        const huntDateInput = document.getElementById('huntDate').value;
        if (!huntDateInput || !huntLocation || !huntZoneInfo.id) {
             alert('Please ensure location is set and time zone has been found.');
            resetButton();
            return;
        }

        let sunInfo = null;
        let adjustedSunrise, adjustedSunset;
        let calcText = '';

        if (currentState === 'NE' && sunData[huntDateInput]) {
            sunInfo = sunData[huntDateInput];
            let [sunsetHour, sunsetMin] = sunInfo.sunset.split(':').map(Number);
            if (sunsetHour < 12) sunsetHour += 12;
            const correctedSunset = `${sunsetHour}:${String(sunsetMin).padStart(2, '0')}`;
            const locationInfo = calculateDistanceFromKearney(huntLocation.lat, huntLocation.lng);
            const timeAdjustmentMinutes = Math.round(locationInfo.distance / MILES_PER_MINUTE);
            const actualAdjustment = locationInfo.direction === 'East' ? -timeAdjustmentMinutes : timeAdjustmentMinutes;
            calcText = `${locationInfo.distance.toFixed(1)} miles ${locationInfo.direction} of Kearney ÷ ${MILES_PER_MINUTE} = ${timeAdjustmentMinutes} min adjustment`;
            adjustedSunrise = adjustTime(sunInfo.sunrise, actualAdjustment);
            adjustedSunset = adjustTime(correctedSunset, actualAdjustment);
            if (huntZoneInfo.abbreviation.startsWith('M')) {
                adjustedSunrise = adjustTime(adjustedSunrise, -60);
                adjustedSunset = adjustTime(adjustedSunset, -60);
                calcText += ' (-1hr for MT)';
            }
        } else {
            const apiSunData = await getSunriseSunsetForLocation(huntLocation.lat, huntLocation.lng, huntDateInput);
            if (apiSunData) {
                const sunriseUtcDate = new Date(apiSunData.sunrise);
                const sunsetUtcDate = new Date(apiSunData.sunset);
                adjustedSunrise = formatUtcDateToTime(sunriseUtcDate, huntZoneInfo.id);
                adjustedSunset = formatUtcDateToTime(sunsetUtcDate, huntZoneInfo.id);
                sunInfo = { sunrise: adjustedSunrise, sunset: adjustedSunset };
                calcText = `Astronomically accurate for lat/lng in ${huntZoneInfo.abbreviation}.`;
            } else {
                alert('Could not fetch sunrise/sunset data. Please check your connection.');
                resetButton();
                return;
            }
        }

        const legalShootingTime = adjustTime(adjustedSunrise, -30);
        const endLegalShooting = (selectedGameType === 'deer') ? adjustTime(adjustedSunset, 30) : adjustedSunset;

        const driveTime = baseDriveTime + driveTimeAdjustment;
        const bufferTime = parseInt(document.getElementById('bufferTime').value) || 0;
        const parkToSetTime = parseInt(document.getElementById('parkToSetTime').value) || 0;
        const setToEstablishTime = parseInt(document.getElementById('setToEstablishTime').value) || 0;

        const huntZoneOffset = getUtcOffsetString(huntZoneInfo.id, huntDateInput);
        const legalShootingIso = `${huntDateInput}T${legalShootingTime}:00${huntZoneOffset}`;
        const legalShootingDate = new Date(legalShootingIso);
        const sunriseDate = new Date(`${huntDateInput}T${adjustedSunrise}:00${huntZoneOffset}`);
        
        const establishedByDate = new Date(legalShootingDate.getTime() - (bufferTime * 60000));
        const setByDate = new Date(establishedByDate.getTime() - (setToEstablishTime * 60000));
        const parkedByDate = new Date(setByDate.getTime() - (parkToSetTime * 60000));
        const leaveByDate = new Date(parkedByDate.getTime() - (driveTime * 60000));
        const endLegalShootingDate = new Date(`${huntDateInput}T${endLegalShooting}:00${huntZoneOffset}`);
        
        const leaveByStr = formatDateToTimeAmPm(leaveByDate, startZoneInfo.id, startZoneInfo.abbreviation);
        const parkedByStr = formatDateToTimeAmPm(parkedByDate, huntZoneInfo.id, huntZoneInfo.abbreviation);
        const setByStr = formatDateToTimeAmPm(setByDate, huntZoneInfo.id, huntZoneInfo.abbreviation);
        const establishedByStr = formatDateToTimeAmPm(establishedByDate, huntZoneInfo.id, huntZoneInfo.abbreviation);
        const legalShootingStr = formatDateToTimeAmPm(legalShootingDate, huntZoneInfo.id, huntZoneInfo.abbreviation);
        const endLegalShootingStr = formatDateToTimeAmPm(endLegalShootingDate, huntZoneInfo.id, huntZoneInfo.abbreviation);
        
        document.getElementById('timeline-results').innerHTML = `<div class="timeline">
            <div class="timeline-item highlight"><div class="timeline-label">Leave By</div><div class="timeline-time">${leaveByStr}</div></div>
            <div class="timeline-item"><div class="timeline-label">Parked By</div><div class="timeline-time">${parkedByStr}</div></div>
            <div class="timeline-item"><div class="timeline-label">At Stand/Blind</div><div class="timeline-time">${setByStr}</div></div>
            <div class="timeline-item"><div class="timeline-label">Established By</div><div class="timeline-time">${establishedByStr}</div></div>
            <div class="timeline-item highlight"><div class="timeline-label">Legal Shooting Begins</div><div class="timeline-time">${legalShootingStr}</div></div>
            <div class="timeline-item highlight"><div class="timeline-label">Legal Shooting Ends</div><div class="timeline-time">${endLegalShootingStr}</div></div>
        </div>`;

        let infoGridHTML = `<div class="info-grid">`;
        const adjustedSunriseStr = formatDateToTimeAmPm(sunriseDate, huntZoneInfo.id, huntZoneInfo.abbreviation);
        const adjustedSunsetStr = formatDateToTimeAmPm(new Date(`${huntDateInput}T${adjustedSunset}:00${huntZoneOffset}`), huntZoneInfo.id, huntZoneInfo.abbreviation);

        if (currentState === 'NE') {
             const chartSunriseStr = formatTimeAMPM(sunInfo.sunrise, 'CT');
             const chartSunsetStr = formatTimeAMPM(sunInfo.sunset, 'CT', true);
             infoGridHTML += `
                <div class="info-item"><div class="info-label">Chart Sunrise</div><div class="info-value">${chartSunriseStr}</div></div>
                <div class="info-item"><div class="info-label">Chart Sunset</div><div class="info-value">${chartSunsetStr}</div></div>
                <div class="info-item"><div class="info-label">Adjusted Sunrise</div><div class="info-value">${adjustedSunriseStr}</div><div class="info-calc">${calcText}<br/><a href="http://digital.outdoornebraska.gov/i/1537408-small-game-and-waterfowl-guide-2025-26-web/39" target="_blank">Pg. 40 2025 Waterfowl Guide</a></div></div>
                <div class="info-item"><div class="info-label">Adjusted Sunset</div><div class="info-value">${adjustedSunsetStr}</div><div class="info-calc">${calcText}</div></div>`;
        } else {
            infoGridHTML += `
                <div class="info-item"><div class="info-label">Location Sunrise</div><div class="info-value">${adjustedSunriseStr}</div></div>
                <div class="info-item"><div class="info-label">Location Sunset</div><div class="info-value">${adjustedSunsetStr}</div></div>
                <div class="info-item"><div class="info-label">State</div><div class="info-value">${currentState || 'Unknown'}</div><div class="info-calc">${calcText}</div></div>
                <div class="info-item"><div class="info-label">Legal Hours</div><div class="info-value">${selectedGameType === 'deer' ? '30 min before sunrise to 30 min after sunset' : '30 min before sunrise to sunset'}</div></div>`;
        }
        
        infoGridHTML += `
            <div class="info-item"><div class="info-label">Game Type</div><div class="info-value">${selectedGameType === 'deer' ? 'Deer' : 'Waterfowl'}</div></div>
            <div class="info-item"><div class="info-label">Total Drive Time</div><div class="info-value">${driveTime} minutes</div></div>
        </div>`;
        
        document.getElementById('info-grid-results').innerHTML = infoGridHTML;
        
        const forecastList = await getWeatherForecast(huntLocation.lat, huntLocation.lng);
        if (forecastList) {
            const forecastHours = [0, 2, 4, 6, 8, 10, 12];
            const targetDates = forecastHours.map(h => new Date(sunriseDate.getTime() + h * 3600 * 1000));
            let weatherHtml = `
                <div class="step-header">
                    <div class="step-number" style="font-size: 1.5rem;">༄</div>
                    <div class="step-title">Weather Forecast</div>
                </div>
                <div class="weather-forecast">`;

            for (const targetDate of targetDates) {
                const bestForecast = findClosestForecast(targetDate, forecastList);
                if (bestForecast) {
                    const timeStr = targetDate.toLocaleTimeString('en-US', { timeZone: huntZoneInfo.id, hour: 'numeric', minute: '2-digit', hour12: true });
                    const deg = bestForecast.wind.deg;
                    const speedMps = bestForecast.wind.speed;
                    const speedMph = Math.round(speedMps * 2.237);
                    const tempCelsius = bestForecast.main.temp;
                    const tempFahrenheit = Math.round(tempCelsius * 9/5 + 32);
                    const direction = degreesToCardinal(deg);
                    const conditions = bestForecast.weather[0].description;
                    
                    weatherHtml += `
                        <div class="weather-item">
                            <div class="weather-time">${timeStr}</div>
                            <div class="weather-arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="transform: rotate(${deg}deg);">
                                    <path d="M12 2L12 19M12 19L7 14M12 19L17 14" stroke="#FFBF00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                </svg>
                            </div>
                            <div class="weather-details">
                                <div class="weather-speed">${speedMph} MPH, ${direction} Wind</div>
                                <div class="weather-conditions">${tempFahrenheit}°F, ${conditions}</div>
                            </div>
                        </div>`;
                }
            }
            weatherHtml += '</div>';
            weatherSection.innerHTML = weatherHtml;
        }
        
        const copyText = `Hunt Plan for ${huntDateInput} in ${currentState || 'location'} (${selectedGameType}):\n\nLeave by: ${leaveByStr}\nParked by: ${parkedByStr}\nAt stand/blind: ${setByStr}\nEstablished: ${establishedByStr}\n\nLegal Shooting: ${legalShootingStr} - ${endLegalShootingStr}\n\nDrive: ${driveTime}m, Walk: ${parkToSetTime}m, Setup: ${setToEstablishTime}m`;
        document.getElementById('copyButton').onclick = function() {
            navigator.clipboard.writeText(copyText).then(() => {
                const btn = this;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'Copied! ✓';
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            }).catch(err => { alert('Failed to copy. Please try again.'); });
        };
        
        updateWizardState('results');
        button.disabled = false;
    }

    // --- Helper & Utility Functions ---
    function setStartZone() { /* ... */ }
    async function getHuntZone(lat, lng) { /* ... */ }
    function getAbbreviation(timeZoneId, date) { /* ... */ }
    function getUtcOffsetString(timeZone, dateStr) { /* ... */ }
    function formatUtcDateToTime(dateObj, timeZoneId) { /* ... */ }
    function formatDateToTimeAmPm(dateObj, timeZoneId, abbreviation) { /* ... */ }
    function updateDriveTimeStatus(message, type) { /* ... */ }
    function updateLocationStatus(message, type) { /* ... */ }
    function updateCalculateButton() { /* ... */ }
    function adjustTime(time, minutes) { /* ... */ }
    function updateLatLngInput(location) { /* ... */ }
    function resetButton() { /* ... */ }
    function setTodaysDate() { /* ... */ }
    function formatTimeAMPM(time24, zoneLabel, correctPM) { /* ... */ }
    function calculateDistanceFromKearney(lat, lng) { /* ... */ }
    function degreesToCardinal(deg) { /* ... */ }
    async function getWeatherForecast(lat, lng) { /* ... */ }
    function findClosestForecast(targetDate, forecastList) { /* ... */ }

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAy5kkSZkLS2ApeXHteQ5MuVIL53L972Jw&libraries=places&callback=initMap"></script>
</body>
</html>
